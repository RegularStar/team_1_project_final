{% extends 'base.html' %}
{% load static %}

{% block title %}{{ certificate.title }} | SkillBridge{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/certificate_detail.css' %}" />
{% endblock %}

{% block content %}
  <article class="detail">
    <header class="detail-header">
      <div class="detail-meta">
        {% if certificate.meta %}
          <p class="breadcrumb">{{ certificate.meta|join:" · " }}</p>
        {% endif %}
        <div class="detail-title">
          <h2>{{ certificate.title }}</h2>
        </div>
        {% if certificate.badges %}
          <div class="detail-badges">
            {% for badge in certificate.badges %}
              <span class="detail-badge detail-badge--{{ badge.variant }}">{{ badge.label }}</span>
            {% endfor %}
          </div>
        {% endif %}
        <div class="tags">
          {% for tag in certificate.tags %}
            <span class="tag">{{ tag }}</span>
          {% endfor %}
        </div>
      </div>
      <div class="difficulty-block">
        <div
          class="difficulty-gauge"
          data-role="difficulty-gauge"
          data-difficulty="{{ certificate.difficulty|default_if_none:0 }}"
          role="img"
          aria-label="난이도 {{ certificate.difficulty }}/10"
        >
          <div class="difficulty-gauge__track" aria-hidden="true">
            <div class="difficulty-gauge__mask"></div>
            <span class="difficulty-gauge__indicator"></span>
          </div>
        </div>
        <div class="difficulty-meta">
          <button type="button" class="info-tooltip difficulty-info" aria-expanded="false" aria-controls="difficulty-popover" title="난이도 안내">!</button>
          <span>난이도 <strong>{{ certificate.difficulty }}/10</strong></span>
        </div>
        <div class="difficulty-popover" id="difficulty-popover" hidden>
          <h4>난이도 안내</h4>
          <table>
            <tbody>
              {% for row in difficulty_scale %}
              <tr>
                <th>{{ row.level }}</th>
                <td>{{ row.description }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </header>

    <section class="summary-section">
      <div class="summary-card is-collapsed" data-role="collapsible-card">
        <div class="summary-card__header">
          <h3>
            <span class="summary-card__label">
              <button class="info-tooltip" type="button" data-tip="자격증이 검증하는 역량에 대한 요약">!</button>
              개요
            </span>
          </h3>
          <button
            type="button"
            class="summary-card__toggle"
            data-role="collapsible-toggle"
            aria-expanded="false"
            aria-controls="summary-overview"
          >
            펼쳐보기
          </button>
        </div>
        <div class="summary-card__content" id="summary-overview" hidden>
          <p>{{ certificate.overview|default:"소개 정보가 준비 중입니다."|linebreaksbr }}</p>
        </div>
      </div>
      <div class="summary-card is-collapsed" data-role="collapsible-card">
        <div class="summary-card__header">
          <h3>
            <span class="summary-card__label">
              <button class="info-tooltip" type="button" data-tip="자격증 취득 후 활용하기 좋은 직무">!</button>
              활용 직무
            </span>
          </h3>
          <button
            type="button"
            class="summary-card__toggle"
            data-role="collapsible-toggle"
            aria-expanded="false"
            aria-controls="summary-roles"
          >
            펼쳐보기
          </button>
        </div>
        <div class="summary-card__content" id="summary-roles" hidden>
          {% if certificate.roles_is_list and certificate.roles %}
            <ul>
              {% for role in certificate.roles %}
                <li>{{ role }}</li>
              {% endfor %}
            </ul>
          {% elif certificate.roles_text %}
            <p>{{ certificate.roles_text|linebreaksbr }}</p>
          {% else %}
            <p>관련 직무 정보가 아직 없어요.</p>
          {% endif %}
        </div>
      </div>
      <div class="summary-card is-collapsed" data-role="collapsible-card">
        <div class="summary-card__header">
          <h3>
            <span class="summary-card__label">
              <button class="info-tooltip" type="button" data-tip="필기, 실기 등 시험 구성 정보">!</button>
              시험 방식
            </span>
          </h3>
          <button
            type="button"
            class="summary-card__toggle"
            data-role="collapsible-toggle"
            aria-expanded="false"
            aria-controls="summary-exam"
          >
            펼쳐보기
          </button>
        </div>
        <div class="summary-card__content" id="summary-exam" hidden>
          <p>{{ certificate.exam_method|default:"시험 방식 정보가 아직 없어요."|linebreaksbr }}</p>
        </div>
      </div>
      <div class="summary-card is-collapsed" data-role="collapsible-card">
        <div class="summary-card__header">
          <h3>
            <span class="summary-card__label">
              <button class="info-tooltip" type="button" data-tip="응시 자격 요건">!</button>
              지원 자격
            </span>
          </h3>
          <button
            type="button"
            class="summary-card__toggle"
            data-role="collapsible-toggle"
            aria-expanded="false"
            aria-controls="summary-eligibility"
          >
            펼쳐보기
          </button>
        </div>
        <div class="summary-card__content" id="summary-eligibility" hidden>
          <p>{{ certificate.eligibility|default:"지원 자격 정보가 아직 없어요."|linebreaksbr }}</p>
        </div>
      </div>
    </section>

    <section class="info-grid">
      <div class="info-card">
        <h3><button class="info-tooltip" type="button" data-tip="평균 학습 기간을 기준으로 한 예상 준비 기간">!</button>예상 소요기간</h3>
        <ul>
          <li>비전공자: {{ certificate.duration.non_major }}</li>
          <li>관련 전공자: {{ certificate.duration.major }}</li>
        </ul>
      </div>
      <div class="info-card">
        <h3><button class="info-tooltip" type="button" data-tip="최근 공개된 합격률 또는 평균 값">!</button>합격률</h3>
        {% if certificate.pass_rates_by_stage %}
          <ul class="stage-pass-rate-list">
            {% for stage in certificate.pass_rates_by_stage %}
              <li>
                <span class="stage-pass-rate-label">
                  <strong>{{ stage.label }}</strong>
                  <span class="stage-pass-rate-meta">{{ stage.year }}년</span>
                </span>
                <span class="stage-pass-rate-value">{{ stage.pass_rate|floatformat:1 }}%</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p>
            {% if certificate.pass_rate is not None %}
              {{ certificate.pass_rate|floatformat:1 }}%
            {% else %}
              데이터가 준비 중입니다.
            {% endif %}
          </p>
        {% endif %}
      </div>
    </section>

    <section class="actions">
      <a class="action-btn" href="{% url 'board_list' certificate.slug %}">게시판 이동하기</a>
      <a class="action-btn" href="{% url 'certificate_statistics' certificate.slug %}">통계페이지 이동하기</a>
      {% if certificate.homepage %}
        <a class="action-btn" href="{{ certificate.homepage }}" target="_blank" rel="noopener">자격증 홈페이지 이동하기</a>
      {% else %}
        <span class="action-btn disabled" aria-disabled="true">자격증 홈페이지 정보 없음</span>
      {% endif %}
    </section>

    <section class="reviews">
      <div class="reviews-head">
        <h3>사용자 난이도</h3>
        <a class="link" href="{% url 'certificate_reviews' certificate.slug %}">전체 보기</a>
      </div>

      <div class="rating-summary">
        <div class="rating-score">
          <div class="rating-score__value">
            <span>{{ rating_summary.average|floatformat:1 }}</span>
            <span class="rating-score__unit">/10</span>
          </div>
          <div
            class="difficulty-gauge difficulty-gauge--summary"
            data-role="difficulty-gauge"
            data-difficulty="{{ rating_summary.average|default_if_none:0 }}"
            aria-label="평균 난이도 {{ rating_summary.average|floatformat:1 }} / 10"
            role="img"
          >
            <div class="difficulty-gauge__track" aria-hidden="true">
              <div class="difficulty-gauge__mask"></div>
              <span class="difficulty-gauge__indicator"></span>
            </div>
          </div>
          <p class="count">{{ rating_summary.total }}명의 난이도 평가</p>
        </div>
        <div class="rating-breakdown">
          {% for item in rating_summary.breakdown %}
          <div class="bar-row">
            <span class="label">{{ item.level }}점</span>
            <div class="bar">
              <span class="fill" style="--progress: {{ item.percent }}%;"></span>
            </div>
            <span class="value">{{ item.count }}개</span>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="review-grid">
        {% if reviews %}
          {% for review in reviews %}
          <article class="review-card{% if review.can_edit %} review-card--editable{% endif %}">
            <div class="review-card__top">
              <div class="review-card__metrics" aria-label="난이도 {{ review.difficulty_display }}/10">
                <span class="difficulty-chip">난이도 {{ review.difficulty_display }}/10</span>
                <div
                  class="difficulty-gauge difficulty-gauge--compact"
                  data-role="difficulty-gauge"
                  data-difficulty="{{ review.difficulty_display }}"
                  aria-hidden="true"
                >
                  <div class="difficulty-gauge__track">
                    <div class="difficulty-gauge__mask"></div>
                    <span class="difficulty-gauge__indicator"></span>
                  </div>
                </div>
              </div>
              {% if review.can_edit %}
              <div class="review-menu" data-role="review-menu">
                <button
                  type="button"
                  class="review-menu__trigger"
                  aria-haspopup="true"
                  aria-expanded="false"
                  aria-label="리뷰 옵션 열기"
                ></button>
                <div class="review-menu__popover" role="menu" hidden>
                  <button
                    type="button"
                    class="review-menu__item"
                    role="menuitem"
                    data-action="edit"
                    data-review-id="{{ review.id }}"
                    data-difficulty="{{ review.difficulty_display }}"
                    data-comment="{{ review.comment_raw|escapejs }}"
                  >
                    수정
                  </button>
                  <form
                    method="post"
                    action="{% url 'certificate_review_delete' certificate.slug review.id %}"
                    class="review-menu__form"
                  >
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                    <button type="submit" class="review-menu__item review-menu__item--danger" role="menuitem">
                      삭제
                    </button>
                  </form>
                </div>
              </div>
              {% endif %}
            </div>
            <h4>{{ review.title }}</h4>
            <p>{{ review.comment|linebreaksbr }}</p>
            <div class="reviewer">
              <strong class="reviewer-name">
                작성자:
                <a class="reviewer-link" href="{% url 'user_profile' review.user_id %}">{{ review.nickname }}</a>
              </strong>
              {% if review.is_certified or review.hell_count or review.elite_count %}
              <div class="reviewer-badges">
                {% if review.is_certified %}
                  <span class="badge-cert">취득</span>
                {% endif %}
                {% if review.hell_count %}
                  <span class="badge-hell">{{ review.hell_count }}관왕</span>
                {% endif %}
                {% if review.elite_count %}
                  <span class="badge-elite">{{ review.elite_count }}관왕</span>
                {% endif %}
              </div>
              {% endif %}
              <time class="reviewer-date">{{ review.date }}</time>
            </div>
          </article>
          {% endfor %}
        {% else %}
          <div class="empty-state">아직 등록된 리뷰가 없어요.</div>
        {% endif %}
      </div>

      <section class="feedback-form" aria-labelledby="difficulty-feedback-title">
        <h4 id="difficulty-feedback-title">체감 난이도 남기기</h4>
        {% if request.user.is_authenticated %}
          {% if can_submit_review %}
            {% if rating_form.errors %}
              <div class="form-errors">
                {% for field in rating_form %}
                  {% for error in field.errors %}
                    <p>{{ error }}</p>
                  {% endfor %}
                {% endfor %}
                {% for error in rating_form.non_field_errors %}
                  <p>{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
            <form method="post" action="{% url 'certificate_review_submit' certificate.slug %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}" />
              <div class="form-row">
                <label for="perceived-difficulty">체감 난이도 <span id="perceived-value">{{ rating_form.difficulty.value|default:5 }}</span>/10</label>
                <div
                  class="feedback-gauge difficulty-gauge difficulty-gauge--feedback"
                  data-role="difficulty-gauge"
                  data-difficulty="{{ rating_form.difficulty.value|default:5 }}"
                >
                  <div class="difficulty-gauge__track" aria-hidden="true">
                    <div class="difficulty-gauge__mask"></div>
                    <span class="difficulty-gauge__indicator"></span>
                  </div>
                  <input
                    type="range"
                    id="perceived-difficulty"
                    name="difficulty"
                    min="1"
                    max="10"
                    value="{{ rating_form.difficulty.value|default:5 }}"
                    data-slider-target="#perceived-value"
                    data-role="difficulty-input"
                    aria-describedby="perceived-value"
                  />
                </div>
              </div>
              <div class="form-row">
                <label class="sr-only" for="feedback-comment">체감 난이도 의견</label>
                <textarea id="feedback-comment" name="content" rows="3" placeholder="체감 난이도와 준비 노하우를 공유해주세요.">{{ rating_form.content.value|default_if_none:"" }}</textarea>
              </div>
              <button type="submit" class="btn">리뷰 등록</button>
            </form>
          {% else %}
            <p class="auth-notice">해당 자격증을 취득한 사용자만 체감 난이도를 남길 수 있어요.</p>
          {% endif %}
        {% else %}
          <p class="auth-notice">리뷰를 남기려면 <a href="{% url 'login' %}?next={{ request.get_full_path }}">로그인</a>이 필요합니다.</p>
        {% endif %}
      </section>
    </section>
  </article>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/certificate_detail.js' %}"></script>
{% endblock %}
