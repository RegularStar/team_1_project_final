{% extends 'base.html' %}
{% load static %}

{% block title %}{{ certificate.title }} 리뷰 | SkillBridge{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/certificate_detail.css' %}" />
  <link rel="stylesheet" href="{% static 'css/certificate_reviews.css' %}" />
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/certificate_detail.js' %}"></script>
{% endblock %}

{% block content %}
  <section class="reviews-page">
    <header class="reviews-page-header">
      <div>
        <p class="breadcrumb">{{ certificate.category }} · {{ certificate.type }}</p>
        <h2>{{ certificate.title }} 리뷰</h2>
      </div>
      <a class="link back-link" href="{% url 'certificate_detail' certificate.slug %}">자격증 상세로 돌아가기</a>
    </header>

    <div class="rating-summary">
      <div class="rating-score">
        <div class="rating-score__value">
          <span>{{ rating_summary.average|floatformat:1 }}</span>
          <span class="rating-score__unit">/10</span>
        </div>
        <div
          class="difficulty-gauge difficulty-gauge--summary"
          data-role="difficulty-gauge"
          data-difficulty="{{ rating_summary.average|default_if_none:0 }}"
          aria-label="평균 난이도 {{ rating_summary.average|floatformat:1 }} / 10"
          role="img"
        >
          <div class="difficulty-gauge__track" aria-hidden="true">
            <div class="difficulty-gauge__mask"></div>
            <span class="difficulty-gauge__indicator"></span>
          </div>
        </div>
        <p class="count">{{ rating_summary.total }}명의 난이도 평가</p>
      </div>
      <div class="rating-breakdown">
        {% for item in rating_summary.breakdown %}
        <div class="bar-row">
          <span class="label">{{ item.level }}점</span>
          <div class="bar">
            <span class="fill" style="--progress: {{ item.percent }}%;"></span>
          </div>
          <span class="value">{{ item.count }}개</span>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="review-grid wide">
      {% for review in reviews %}
      <article class="review-card{% if review.can_edit %} review-card--editable{% endif %}">
        <div class="review-card__top">
          <div class="review-card__metrics" aria-label="난이도 {{ review.difficulty_display }}/10">
            <span class="difficulty-chip">난이도 {{ review.difficulty_display }}/10</span>
            <div
              class="difficulty-gauge difficulty-gauge--compact"
              data-role="difficulty-gauge"
              data-difficulty="{{ review.difficulty_display }}"
              aria-hidden="true"
            >
              <div class="difficulty-gauge__track">
                <div class="difficulty-gauge__mask"></div>
                <span class="difficulty-gauge__indicator"></span>
              </div>
            </div>
          </div>
          {% if review.can_edit %}
          <div class="review-menu" data-role="review-menu">
            <button
              type="button"
              class="review-menu__trigger"
              aria-haspopup="true"
              aria-expanded="false"
              aria-label="리뷰 옵션 열기"
            ></button>
            <div class="review-menu__popover" role="menu" hidden>
              <button
                type="button"
                class="review-menu__item"
                role="menuitem"
                data-action="edit"
                data-review-id="{{ review.id }}"
                data-difficulty="{{ review.difficulty_display }}"
                data-comment="{{ review.comment_raw|escapejs }}"
              >
                수정
              </button>
              <form
                method="post"
                action="{% url 'certificate_review_delete' certificate.slug review.id %}"
                class="review-menu__form"
              >
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                <button type="submit" class="review-menu__item review-menu__item--danger" role="menuitem">
                  삭제
                </button>
              </form>
            </div>
          </div>
          {% endif %}
        </div>
        <h4>{{ review.title }}</h4>
        <p>{{ review.comment|linebreaksbr }}</p>
        <div class="reviewer">
          <strong class="reviewer-name">
            작성자:
            <a class="reviewer-link" href="{% url 'user_profile' review.user_id %}">{{ review.nickname }}</a>
          </strong>
          {% if review.is_certified or review.hell_count or review.elite_count %}
          <div class="reviewer-badges">
            {% if review.is_certified %}
              <span class="badge-cert">취득</span>
            {% endif %}
            {% if review.hell_count %}
              <span class="badge-hell">{{ review.hell_count }}관왕</span>
            {% endif %}
            {% if review.elite_count %}
              <span class="badge-elite">{{ review.elite_count }}관왕</span>
            {% endif %}
          </div>
          {% endif %}
          <time class="reviewer-date">{{ review.date }}</time>
        </div>
      </article>
      {% endfor %}
    </div>

    <section class="feedback-form" aria-labelledby="reviews-feedback-title">
      <h4 id="reviews-feedback-title">체감 난이도 남기기</h4>
      {% if request.user.is_authenticated %}
        {% if can_submit_review %}
          {% if rating_form.errors %}
            <div class="form-errors">
              {% for field in rating_form %}
                {% for error in field.errors %}
                  <p>{{ error }}</p>
                {% endfor %}
              {% endfor %}
              {% for error in rating_form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}
          <form method="post" action="{% url 'certificate_review_submit' certificate.slug %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}" />
            <div class="form-row">
              <label for="reviews-perceived-difficulty">체감 난이도 <span id="reviews-perceived-value">{{ rating_form.difficulty.value|default:5 }}</span>/10</label>
              <div
                class="feedback-gauge difficulty-gauge difficulty-gauge--feedback"
                data-role="difficulty-gauge"
                data-difficulty="{{ rating_form.difficulty.value|default:5 }}"
              >
                <div class="difficulty-gauge__track" aria-hidden="true">
                  <div class="difficulty-gauge__mask"></div>
                  <span class="difficulty-gauge__indicator"></span>
                </div>
                <input
                  type="range"
                  id="reviews-perceived-difficulty"
                  name="difficulty"
                  min="1"
                  max="10"
                  value="{{ rating_form.difficulty.value|default:5 }}"
                  data-slider-target="#reviews-perceived-value"
                  data-role="difficulty-input"
                  aria-describedby="reviews-perceived-value"
                />
              </div>
            </div>
            <div class="form-row">
              <label class="sr-only" for="reviews-feedback-comment">체감 난이도 의견</label>
              <textarea id="reviews-feedback-comment" name="content" rows="3" placeholder="체감 난이도와 후기를 남겨주세요.">{{ rating_form.content.value|default_if_none:"" }}</textarea>
            </div>
            <button type="submit" class="btn">리뷰 등록</button>
          </form>
        {% else %}
          <p class="auth-notice">해당 자격증을 취득한 사용자만 체감 난이도를 남길 수 있어요.</p>
        {% endif %}
      {% else %}
        <p class="auth-notice">리뷰를 남기려면 <a href="{% url 'login' %}?next={{ request.get_full_path }}">로그인</a>이 필요합니다.</p>
      {% endif %}
    </section>

    {% if review_page_obj %}
    <nav class="pagination" aria-label="리뷰 페이지">
      {% if review_page_obj.number > 1 %}
        <a class="pagination__nav" href="?page=1" aria-label="첫 페이지">처음</a>
      {% else %}
        <span class="pagination__nav disabled">처음</span>
      {% endif %}

      {% if review_page_obj.has_previous %}
        <a class="pagination__nav" href="?page={{ review_page_obj.previous_page_number }}" aria-label="이전 페이지">‹</a>
      {% else %}
        <span class="pagination__nav disabled" aria-hidden="true">‹</span>
      {% endif %}

      <ul class="pagination__list">
        {% for number in review_page_numbers %}
          {% if number %}
            <li>
              {% if number == review_page_obj.number %}
                <span class="pagination__number active">{{ number }}</span>
              {% else %}
                <a class="pagination__number" href="?page={{ number }}">{{ number }}</a>
              {% endif %}
            </li>
          {% else %}
            <li><span class="pagination__ellipsis" aria-hidden="true">…</span></li>
          {% endif %}
        {% endfor %}
      </ul>

      {% if review_page_obj.has_next %}
        <a class="pagination__nav" href="?page={{ review_page_obj.next_page_number }}" aria-label="다음 페이지">›</a>
      {% else %}
        <span class="pagination__nav disabled" aria-hidden="true">›</span>
      {% endif %}

      {% if review_page_obj.number < review_page_obj.paginator.num_pages %}
        <a class="pagination__nav" href="?page={{ review_page_obj.paginator.num_pages }}" aria-label="마지막 페이지">마지막</a>
      {% else %}
        <span class="pagination__nav disabled">마지막</span>
      {% endif %}
    </nav>
    {% endif %}
  </section>
{% endblock %}
