{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}자격증 검색 | SkillBridge{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/search.css' %}" />
{% endblock %}

{% block content %}
<<<<<<< HEAD
  <form id="search-form" class="search-form" method="get">
=======
  <form
    id="search-form"
    class="search-form"
    method="get"
    data-tags-endpoint="{% url 'tag-list' %}"
  >
>>>>>>> seil2
    <section class="search-hero">
      <h2>원하는 자격증을 검색해보세요.</h2>
      <p>키워드, 난이도, 합격률 필터를 이용해 맞춤 자격증을 빠르게 찾아보세요.</p>
      <div class="search-bar">
        <label class="sr-only" for="keyword">자격증 검색</label>
        <input id="keyword" name="q" type="search" placeholder="검색어를 입력해주세요." value="{{ query }}" />
        <button type="submit" class="btn">검색</button>
      </div>
<<<<<<< HEAD
      <div class="quick-tags">
        {% for tag in quick_tags %}
          <button type="button" class="chip{% if tag.id in selected_tag_ids %} active{% endif %}" data-tag-id="{{ tag.id }}" data-tag-label="{{ tag.name }}">{{ tag.name }}</button>
        {% empty %}
          <span class="chip disabled">추천 태그가 아직 없어요.</span>
        {% endfor %}
=======
      <div class="tag-picker" data-role="tag-picker">
        <button type="button" class="btn secondary" data-role="open-tag-modal">태그 추가하기</button>
>>>>>>> seil2
      </div>
      <input type="hidden" name="sort" value="{{ selected_sort }}" />
    </section>

<<<<<<< HEAD
=======
    <div class="tag-modal hidden" data-role="tag-modal" aria-hidden="true">
      <div class="tag-modal__backdrop" data-role="tag-modal-close"></div>
      <div class="tag-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="tag-modal-title">
        <header class="tag-modal__header">
          <h3 id="tag-modal-title">태그 검색</h3>
          <button type="button" class="tag-modal__close" data-role="tag-modal-close" aria-label="태그 검색 닫기">×</button>
        </header>
        <div class="tag-modal__search">
          <label class="sr-only" for="tag-modal-search-input">태그 검색어 입력</label>
          <input id="tag-modal-search-input" type="search" placeholder="태그 이름을 검색하세요." autocomplete="off" />
        </div>
        <div class="tag-modal__results" data-role="tag-modal-results"></div>
        <footer class="tag-modal__footer">
          <p class="tag-modal__hint">검색 결과를 클릭하면 키워드가 추가됩니다. ESC 키로 닫을 수 있어요.</p>
        </footer>
      </div>
    </div>

    {{ quick_tag_payload|json_script:"tag-suggestions-data" }}

>>>>>>> seil2
    <section class="search-body">
      <aside class="filters" aria-label="필터">
        <h3 class="filters-heading">필터</h3>

<<<<<<< HEAD
        <div class="filter-section">
          <h4 class="filter-title">선택한 키워드</h4>
=======
        <div class="filter-section filter-section--bordered">
          <h4 class="filter-title">선택한 태그</h4>
>>>>>>> seil2
          <div class="selected-tag-inputs" data-role="selected-tag-inputs">
          {% for tag in selected_tags %}
            <input type="hidden" name="tag" value="{{ tag.id }}" data-tag-label="{{ tag.name }}" />
          {% endfor %}
          </div>

          <div class="chip-list" data-role="selected-tags-display">
            {% if selected_tags %}
              {% for tag in selected_tags %}
                <button type="button" class="chip selected" data-tag-id="{{ tag.id }}" data-tag-label="{{ tag.name }}">{{ tag.name }}</button>
              {% endfor %}
            {% else %}
              <p class="empty-copy">선택된 키워드가 없습니다.</p>
            {% endif %}
          </div>
        </div>

<<<<<<< HEAD
        <div class="filter-section">
=======
        <div class="filter-section filter-section--bordered">
>>>>>>> seil2
          <h4 class="filter-title">자격 유형</h4>
          <div class="checkbox-group">
            {% for value, label in type_filters %}
              <label class="checkbox">
                <input type="checkbox" name="type" value="{{ value }}" {% if value in selected_types %}checked{% endif %} /> {{ label }}
              </label>
            {% endfor %}
          </div>
        </div>

<<<<<<< HEAD
        <div class="filter-section">
          <h4 class="filter-title">난이도</h4>
          <div class="range-group">
            <div class="range-row">
              <input
                id="difficulty-min"
                name="difficulty_min"
              type="number"
              inputmode="numeric"
              min="0"
              max="10"
              step="1"
              value="{{ difficulty_min|floatformat:0 }}"
              aria-label="난이도 최소값"
            />
            <span class="range-sep">~</span>
            <input
              id="difficulty-max"
              name="difficulty_max"
              type="number"
              inputmode="numeric"
              min="0"
              max="10"
              step="1"
              value="{{ difficulty_max|floatformat:0 }}"
              aria-label="난이도 최대값"
            />
          </div>
          <p class="range-hint">0~10 사이의 정수를 입력하세요.</p>
        </div>

        <div class="filter-section">
          <h4 class="filter-title">합격률</h4>
=======
        <div class="filter-section filter-section--bordered">
          <h4 class="filter-title">공식 난이도</h4>
          <div class="range-group">
            <div class="range-row">
              <input
                id="difficulty-official-min"
                name="difficulty_official_min"
                type="number"
                inputmode="numeric"
                min="0"
                max="10"
                step="1"
                value="{{ difficulty_official_min|floatformat:0 }}"
                data-default="0"
                aria-label="공식 난이도 최소값"
              />
              <span class="range-sep">~</span>
              <input
                id="difficulty-official-max"
                name="difficulty_official_max"
                type="number"
                inputmode="numeric"
                min="0"
                max="10"
                step="1"
                value="{{ difficulty_official_max|floatformat:0 }}"
                data-default="10"
                aria-label="공식 난이도 최대값"
              />
            </div>
            <p class="range-hint">0~10 사이의 정수를 입력하세요.</p>
          </div>
        </div>

        <div class="filter-section filter-section--bordered">
          <h4 class="filter-title">사용자 난이도</h4>
          <div class="range-group">
            <div class="range-row">
              <input
                id="difficulty-user-min"
                name="difficulty_user_min"
                type="number"
                inputmode="numeric"
                min="0"
                max="10"
                step="1"
                value="{{ difficulty_user_min|floatformat:0 }}"
                data-default="0"
                aria-label="사용자 난이도 최소값"
              />
              <span class="range-sep">~</span>
              <input
                id="difficulty-user-max"
                name="difficulty_user_max"
                type="number"
                inputmode="numeric"
                min="0"
                max="10"
                step="1"
                value="{{ difficulty_user_max|floatformat:0 }}"
                data-default="10"
                aria-label="사용자 난이도 최대값"
              />
            </div>
            <p class="range-hint">사용자 평가 평균을 기준으로 필터링합니다.</p>
          </div>
        </div>

        <div class="filter-section filter-section--bordered">
          <h4 class="filter-title">합격률</h4>
          <select
            id="pass-rate-stage"
            name="pass_rate_stage"
            class="stage-select"
            aria-label="합격률 시험 차수 선택"
            data-default=""
          >
            {% for value, label in stage_filter_choices %}
              <option value="{{ value }}" {% if value == pass_rate_stage %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <p class="filter-hint">시험차수를 선택해주세요.</p>
>>>>>>> seil2
          <div class="range-group">
            <div class="range-row">
              <input
                id="pass-rate-min"
                name="pass_rate_min"
                type="number"
                inputmode="numeric"
                min="0"
                max="100"
                step="1"
                value="{{ pass_rate_min|floatformat:0 }}"
<<<<<<< HEAD
=======
                data-default="0"
>>>>>>> seil2
                aria-label="합격률 최소값"
              />
              <span class="range-sep">~</span>
              <input
                id="pass-rate-max"
                name="pass_rate_max"
                type="number"
                inputmode="numeric"
                min="0"
                max="100"
                step="1"
                value="{{ pass_rate_max|floatformat:0 }}"
<<<<<<< HEAD
=======
                data-default="100"
>>>>>>> seil2
                aria-label="합격률 최대값"
              />
              <span class="range-unit">%</span>
            </div>
            <p class="range-hint">0~100 범위의 정수를 입력하세요.</p>
          </div>
        </div>

<<<<<<< HEAD
        <button type="submit" class="btn apply-btn">필터 적용</button>
=======
        <div class="filter-section filter-section--bordered">
          <h4 class="filter-title">응시자수</h4>
          <select
            id="applicants-stage"
            name="applicants_stage"
            class="stage-select"
            aria-label="응시자수 시험 차수 선택"
            data-default=""
          >
            {% for value, label in stage_filter_choices %}
              <option value="{{ value }}" {% if value == applicants_stage %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <p class="filter-hint">시험차수를 선택해주세요.</p>
          <div class="range-group">
            <div class="range-row">
              <input
                id="applicants-min"
                name="applicants_min"
                type="number"
                inputmode="numeric"
                min="0"
                step="1"
                value="{{ applicants_min }}"
                aria-label="응시자수 최소값"
              />
              <span class="range-sep">~</span>
              <input
                id="applicants-max"
                name="applicants_max"
                type="number"
                inputmode="numeric"
                min="0"
                step="1"
                value="{{ applicants_max }}"
                aria-label="응시자수 최대값"
              />
              <span class="range-unit">명</span>
            </div>
            <p class="range-hint">정수 값을 입력하세요.</p>
          </div>
        </div>

        <div class="filters-actions">
          <button type="button" class="btn filters-reset" data-role="reset-filters">초기화</button>
          <button type="submit" class="btn apply-btn filters-apply">필터 적용</button>
        </div>
>>>>>>> seil2
      </aside>

      <div class="results">
        <div class="result-toolbar">
          <span class="result-count">총 {{ total_count|intcomma }}건</span>
          <div class="sort-chips" role="tablist" aria-label="정렬 기준">
            {% for value, label in sort_options %}
              <a class="chip{% if value == selected_sort %} active{% endif %}" href="?{% if sort_querystring %}{{ sort_querystring }}&{% endif %}sort={{ value }}">{{ label }}</a>
            {% endfor %}
          </div>
        </div>

        {% if results_page.object_list %}
          <div class="result-grid">
            {% for certificate in results_page %}
<<<<<<< HEAD
              <article class="result-card">
                <header>
                  <span class="category">{{ certificate.type_category }}</span>
                  <h4>{{ certificate.name }}</h4>
                </header>
                <p>{{ certificate.overview|default:"소개 정보가 준비 중입니다."|truncatechars:140 }}</p>
                <dl class="meta">
                  <div>
                    <dt>합격률</dt>
                    <dd>
                      {% if certificate.latest_pass_rate %}
                        {{ certificate.latest_pass_rate|floatformat:1 }}%
                      {% else %}
                        —
                      {% endif %}
                    </dd>
                  </div>
                  <div>
                    <dt>응시자수</dt>
                    <dd>
                      {% if certificate.applicants_metric %}
                        {{ certificate.applicants_metric|intcomma }}명
                      {% else %}
                        —
                      {% endif %}
                    </dd>
                  </div>
                  <div>
                    <dt>난이도</dt>
                    <dd>
=======
              <article class="result-card" tabindex="0" role="button" data-detail-url="{% url 'certificate_detail' certificate.id %}">
                <header class="result-card__header">
                  <span class="category">{{ certificate.type_category }}</span>
                  <h4>{{ certificate.name }}</h4>
                </header>
                <div class="result-card__summary">
                  <p>{{ certificate.overview|default:"소개 정보가 준비 중입니다."|truncatechars:140 }}</p>
                </div>
                <div class="result-card__difficulty">
                  <div class="difficulty-row">
                    <span class="difficulty-label">공식 난이도</span>
                    <span class="difficulty-value">
>>>>>>> seil2
                      {% if certificate.rating %}
                        {{ certificate.rating }}/10
                      {% else %}
                        —
                      {% endif %}
<<<<<<< HEAD
                    </dd>
                  </div>
                </dl>
                {% if certificate.tags.all %}
                  <ul class="tag-list">
                    {% for tag in certificate.tags.all|slice:':3' %}
                      <li>{{ tag.name }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
                <a class="detail-link" href="{% url 'certificate_detail' certificate.id %}">상세 보기</a>
=======
                    </span>
                  </div>
                  <div class="difficulty-row">
                    <span class="difficulty-label">사용자 난이도</span>
                    <span class="difficulty-value">
                      {% if certificate.user_difficulty_average is not None %}
                        {{ certificate.user_difficulty_average|floatformat:1 }}/10.0
                        {% if certificate.user_difficulty_count %}
                          <span class="difficulty-footnote">{{ certificate.user_difficulty_count|intcomma }}명 평가</span>
                        {% endif %}
                      {% else %}
                        —
                      {% endif %}
                    </span>
                  </div>
                </div>
                <div class="result-card__stats">
                  <div class="result-card__stats-header">
                    <h5>시험 통계</h5>
                    {% if certificate.stats_baseline_year %}
                      <span class="stats-baseline">기준년도: {{ certificate.stats_baseline_year }}</span>
                    {% endif %}
                  </div>
                  {% if certificate.stats_baseline_year %}
                    <ul class="stage-stats">
                      {% for stage in certificate.stage_statistics %}
                        <li>
                          <p class="stage-title">{{ stage.label }}</p>
                          <p class="stage-line">
                            <span class="stage-line__label">응시자수</span>
                            <span class="stage-line__value">
                              {% if stage.applicants is not None %}
                                {{ stage.applicants|intcomma }}명
                              {% else %}
                                —
                              {% endif %}
                            </span>
                          </p>
                          <p class="stage-line">
                            <span class="stage-line__label">합격률</span>
                            <span class="stage-line__value">
                              {% if stage.pass_rate is not None %}
                                {{ stage.pass_rate|floatformat:1 }}%
                              {% else %}
                                —
                              {% endif %}
                            </span>
                          </p>
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <p class="empty-copy">통계 정보가 준비 중입니다.</p>
                  {% endif %}
                </div>
>>>>>>> seil2
              </article>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <p>검색 조건에 맞는 자격증을 찾지 못했어요.</p>
            <p class="hint">필터를 완화하거나 다른 키워드를 시도해보세요.</p>
          </div>
        {% endif %}

        {% if results_page.paginator.num_pages > 1 %}
          <nav class="pagination" aria-label="검색 결과 페이지">
<<<<<<< HEAD
            {% if results_page.has_previous %}
              <a class="page-btn prev" href="?{% if base_querystring %}{{ base_querystring }}&{% endif %}page={{ results_page.previous_page_number }}">이전</a>
            {% else %}
              <span class="page-btn prev disabled">이전</span>
            {% endif %}

            <ul class="page-list">
              {% for number in page_numbers %}
                {% if number %}
                  {% if number == results_page.number %}
                    <span class="page-number active">{{ number }}</span>
                  {% else %}
                    <a class="page-number" href="?{% if base_querystring %}{{ base_querystring }}&{% endif %}page={{ number }}">{{ number }}</a>
                  {% endif %}
                {% else %}
                  <span class="page-ellipsis" aria-hidden="true">…</span>
                {% endif %}
=======
            {% if results_page.number > 1 %}
              <a class="pagination__nav" href="?{% if base_querystring %}{{ base_querystring }}&{% endif %}page=1" aria-label="첫 페이지">처음</a>
            {% else %}
              <span class="pagination__nav disabled">처음</span>
            {% endif %}

            {% if results_page.has_previous %}
              <a class="pagination__nav" href="?{% if base_querystring %}{{ base_querystring }}&{% endif %}page={{ results_page.previous_page_number }}" aria-label="이전 페이지">‹</a>
            {% else %}
              <span class="pagination__nav disabled" aria-hidden="true">‹</span>
            {% endif %}

            <ul class="pagination__list">
              {% for number in page_chunk %}
                <li>
                  {% if number == results_page.number %}
                    <span class="pagination__number active">{{ number }}</span>
                  {% else %}
                    <a class="pagination__number" href="?{% if base_querystring %}{{ base_querystring }}&{% endif %}page={{ number }}">{{ number }}</a>
                  {% endif %}
                </li>
>>>>>>> seil2
              {% endfor %}
            </ul>

            {% if results_page.has_next %}
<<<<<<< HEAD
              <a class="page-btn next" href="?{% if base_querystring %}{{ base_querystring }}&{% endif %}page={{ results_page.next_page_number }}">다음</a>
            {% else %}
              <span class="page-btn next disabled">다음</span>
=======
              <a class="pagination__nav" href="?{% if base_querystring %}{{ base_querystring }}&{% endif %}page={{ results_page.next_page_number }}" aria-label="다음 페이지">›</a>
            {% else %}
              <span class="pagination__nav disabled" aria-hidden="true">›</span>
            {% endif %}

            {% if results_page.number < results_page.paginator.num_pages %}
              <a class="pagination__nav" href="?{% if base_querystring %}{{ base_querystring }}&{% endif %}page={{ results_page.paginator.num_pages }}" aria-label="마지막 페이지">마지막</a>
            {% else %}
              <span class="pagination__nav disabled">마지막</span>
>>>>>>> seil2
            {% endif %}
          </nav>
        {% endif %}
      </div>
    </section>
  </form>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/search.js' %}"></script>
{% endblock %}
